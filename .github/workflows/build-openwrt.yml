name: Build OpenWrt (Auto + Snapshot)

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 2 * * *"  # daily snapshot at 02:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------
      # Checkout repository
      # ---------------------------------
      - uses: actions/checkout@v4

      # ---------------------------------
      # Detect if this is a snapshot build
      # ---------------------------------
      - name: Determine build type
        id: buildtype
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "snapshot=true" >> $GITHUB_OUTPUT
            echo "Detected: SNAPSHOT build"
          else
            echo "snapshot=false" >> $GITHUB_OUTPUT
            echo "Detected: NORMAL build"
          fi

      # ---------------------------------
      # Install required build dependencies
      # ---------------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib flex git \
            libncurses-dev libssl-dev python3-distutils python3-setuptools \
            zlib1g-dev rsync swig unzip wget ccache

      # ---------------------------------
      # Clone OpenWrt source tree
      # ---------------------------------
      - name: Clone OpenWrt source
        run: |
          git clone --depth 1 https://github.com/openwrt/openwrt.git src

      # ---------------------------------
      # Copy .config from config/.config
      # ---------------------------------
      - name: Apply custom .config
        run: |
          cp config/.config src/.config

      # ---------------------------------
      # Apply all patches from patches/
      # ---------------------------------
      - name: Apply patches
        run: |
          cd src
          for p in ../patches/*.patch; do
            [ -f "$p" ] || continue
            echo "Applying $p"
            patch -p1 < "$p"
          done

      # ---------------------------------
      # Update and install feeds
      # ---------------------------------
      - name: Update feeds
        run: |
          cd src
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ---------------------------------
      # Finalize config after feeds
      # ---------------------------------
      - name: defconfig
        run: |
          cd src
          make defconfig

      # ---------------------------------
      # Detect target / subtarget automatically
      # ---------------------------------
      - name: Detect target
        id: detect_target
        run: |
          TARGET=$(grep "^CONFIG_TARGET_[^_]*=y" src/.config | sed 's/CONFIG_TARGET_//;s/=y//')
          SUBTARGET=$(grep "^CONFIG_TARGET_${TARGET}_.*=y" src/.config | sed "s/CONFIG_TARGET_${TARGET}_//;s/=y//")
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "subtarget=$SUBTARGET" >> $GITHUB_OUTPUT
          echo "Detected Target: $TARGET / $SUBTARGET"

      # ---------------------------------
      # Auto-detect device profile
      # ---------------------------------
      - name: Detect profile
        id: detect_profile
        run: |
          PROFILE=$(grep "^CONFIG_TARGET_.*_DEVICE_.*=y" src/.config | sed 's/.*DEVICE_//;s/=y//')
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT
          echo "Detected profile: $PROFILE"

      # ---------------------------------
      # Detect WiFi packages
      # ---------------------------------
      - name: Detect WiFi drivers
        id: wifi
        run: |
          WIFI=$(grep -E "CONFIG_PACKAGE_(iw|iwinfo|hostapd|wpad|mt76|ath10k|ath9k)=y" src/.config || true)
          WIFI_LIST=$(echo "$WIFI" | sed 's/CONFIG_PACKAGE_//g;s/=y//g' | tr '\n' ' ')
          echo "wifi=$WIFI_LIST" >> $GITHUB_OUTPUT
          echo "WiFi detected: $WIFI_LIST"

      # ---------------------------------
      # Generate changelog (between last 2 commits)
      # ---------------------------------
      - name: Generate changelog
        id: changelog
        run: |
          git fetch --depth=20 origin main
          PREV=$(git rev-parse HEAD~1 || echo "INITIAL")
          CURRENT=$(git rev-parse HEAD)
          if [ "$PREV" = "INITIAL" ]; then
            echo "First build" > changelog.txt
          else
            git log --pretty=format:"%h - %s" $PREV..$CURRENT > changelog.txt
          fi
          echo "log<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Print full directory tree before build
      # ---------------------------------
      - name: Show directory structure
        run: |
          find src | head -n 200

      # ---------------------------------
      # Export ccache + speed flags
      # ---------------------------------
      - name: Optimize build
        run: |
          echo "export CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "export CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
          echo "export MAKEFLAGS=-j$(nproc)" >> $GITHUB_ENV

      # ---------------------------------
      # Build OpenWrt
      # ---------------------------------
      - name: Build firmware
        run: |
          cd src
          make -j$(nproc) V=sc
        continue-on-error: true

      # ---------------------------------
      # Upload build logs on failure
      # ---------------------------------
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: src/logs/

      # ---------------------------------
      # Upload compiled firmware
      # ---------------------------------
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ steps.detect_profile.outputs.profile }}-${{ steps.detect_target.outputs.target }}-${{ steps.detect_target.outputs.subtarget }}${{ steps.buildtype.outputs.snapshot == 'true' && '-snapshot' || '' }}
          path: src/bin/targets/${{ steps.detect_target.outputs.target }}/${{ steps.detect_target.outputs.subtarget }}/
          if-no-files-found: error

      # ---------------------------------
      # Create GitHub Release (SNAPSHOT ONLY)
      # ---------------------------------
      - name: Create GitHub Release
        if: steps.buildtype.outputs.snapshot == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: snapshot-${{ steps.detect_profile.outputs.profile }}-${{ github.run_id }}
          name: "Snapshot Build - ${{ steps.detect_profile.outputs.profile }} - $(date +'%Y-%m-%d')"
          body: |
            ## Snapshot Build
            **Device:** ${{ steps.detect_profile.outputs.profile }}
            **Target:** ${{ steps.detect_target.outputs.target }}/${{ steps.detect_target.outputs.subtarget }}
            **Date:** $(date -u +"%Y-%m-%d %H:%M UTC")

            ### WiFi Packages
            ${{ steps.wifi.outputs.wifi }}

            ### Changelog
            ${{ steps.changelog.outputs.log }}

          files: |
            src/bin/targets/${{ steps.detect_target.outputs.target }}/${{ steps.detect_target.outputs.subtarget }}/*
