name: Build OpenWrt (Stable Patch Workflow)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # nightly snapshot

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 720

    steps:
      # -----------------------------------------
      # Fetch repository
      # -----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------
      # Required build dependencies
      # -----------------------------------------
      - name: Install packages
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential gcc-multilib g++-multilib \
            flex bison gawk libncurses-dev libssl-dev \
            python3-distutils python3-setuptools \
            zlib1g-dev swig rsync unzip wget ccache patch

      # -----------------------------------------
      # Clone OpenWrt
      # -----------------------------------------
      - name: Clone OpenWrt master
        run: |
          git clone --depth 1 https://github.com/openwrt/openwrt.git src

      # -----------------------------------------
      # Apply custom .config from your repo
      # -----------------------------------------
      - name: Install .config
        run: |
          cp config/.config src/.config

      - name: Install latest mt76
        run: |
          cd src/package/kernel

          echo "Removing bundled mt76..."
          rm -rf mt76

          echo "Cloning freshest mt76..."
          git clone --depth 1 https://github.com/openwrt/mt76.git

          echo "Replacing mt76 with upstream version:"
          ls -1 mt76
          
      # Turbo-ccache (max speed)
      - name: Restore ccache
        uses: actions/cache@v3
        with:
         path: ${{ github.workspace }}/.ccache
         key: ccache-${{ github.ref }}-${{ hashFiles('config/.config') }}
         restore-keys: |
          ccache-${{ github.ref }}
          ccache-

      - name: Setup ccache
        run: |
         export CCACHE_DIR="${{ github.workspace }}/.ccache"
         mkdir -p "$CCACHE_DIR"
         ccache -M 10G
         ccache --set-config=compression=true
         ccache --set-config=compression_level=6
         ccache --set-config=sloppiness=locale,time_macros,include_file_mtime
         echo "CC='ccache gcc'" >> $GITHUB_ENV
         echo "CXX='ccache g++'" >> $GITHUB_ENV
         echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
         ccache -s

        # ----------------------------------------
        # DL CACHE (after clone, before make)
        # ----------------------------------------
      - name: Restore DL cache
        uses: actions/cache@v3
        with:
         path: src/dl
         key: dl-cache


      # -----------------------------------------
      # Apply patches from patches/
      # (We use ONLY patch -p1 to avoid git identity issues)
      # -----------------------------------------
      - name: Apply patches
        run: |
          cd src
          shopt -s nullglob
          for p in ../patches/*.patch; do
            echo "=== Applying $p ==="
            if patch -p1 < "$p"; then
              echo "Applied: $p"
            else
              echo "::error ::Patch failed: $p"
              exit 1
            fi
          done

      # ----------------------------------------
      # FEEDS CACHE
      # ----------------------------------------
      - name: Restore feed cache
        uses: actions/cache@v3
        with:
         path: src/feeds
         key: feed-${{ github.ref }}
         restore-keys: feed-

      # -----------------------------------------
      # Install and update feeds
      # -----------------------------------------
      - name: Update feeds
        run: |
          cd src
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Save feed cache
        if: success()
        uses: actions/cache@v3
        with:
         path: src/feeds
         key: feed-${{ github.ref }}
         
        # ----------------------------------------
        # TOOLCHAIN + STAGING_DIR CACHE
        # ----------------------------------------
      - name: Restore toolchain cache
        uses: actions/cache@v3
        with:
         path: |
          src/staging_dir
          src/build_dir/toolchain-*
         key: toolchain-${{ github.ref }}-${{ hashFiles('config/.config') }}
         restore-keys: |
          toolchain-${{ github.ref }}
          toolchain-

      # -----------------------------------------
      # Expand config with defconfig
      # -----------------------------------------
      - name: Run defconfig
        run: |
          cd src
          make defconfig

      # -----------------------------------------
      # Build firmware
      # -----------------------------------------
      - name: Build firmware
        run: |
          cd src
          make -s -j$(nproc) V=sc

      # -----------------------------------------
      # Upload logs on failure
      # -----------------------------------------
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: src/logs/

      - name: Save toolchain cache
        if: success()
        uses: actions/cache@v3
        with:
         path: |
          src/staging_dir
          src/build_dir/toolchain-*
         key: toolchain-${{ github.ref }}-${{ hashFiles('config/.config') }}

      # -----------------------------------------
      # Upload firmware output
      # -----------------------------------------
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ steps.detect.outputs.profile }}
          path: src/bin/targets/${{ steps.detect.outputs.target }}/${{ steps.detect.outputs.subtarget }}/
          if-no-files-found: error

      # -----------------------------------------
      # Optional: Create GitHub Release (snapshot only)
      # -----------------------------------------
      - name: Create snapshot release
        if: github.event_name == 'schedule'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: snapshot-${{ steps.detect.outputs.profile }}-${{ github.run_id }}
          name: "Snapshot for ${{ steps.detect.outputs.profile }} (build ${{ github.run_id }})"
          body: |
            Snapshot firmware for:
            - Device: ${{ steps.detect.outputs.profile }}
            - Target: ${{ steps.detect.outputs.target }}/${{ steps.detect.outputs.subtarget }}
            - Build ID: ${{ github.run_id }}

          files: src/bin/targets/${{ steps.detect.outputs.target }}/${{ steps.detect.outputs.subtarget }}/**
