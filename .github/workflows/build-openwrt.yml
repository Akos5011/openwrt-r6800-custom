name: Build OpenWrt (Auto + Snapshot)

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 2 * * *"  # daily snapshot at 02:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------
      # Checkout repository
      # ---------------------------------
      - uses: actions/checkout@v4

      # ---------------------------------
      # Determine build type
      # ---------------------------------
      - name: Determine build type
        id: buildtype
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "snapshot=true" >> $GITHUB_OUTPUT
            echo "Detected: SNAPSHOT build"
          else
            echo "snapshot=false" >> $GITHUB_OUTPUT
            echo "Detected: NORMAL build"
          fi

      # ---------------------------------
      # Generate timestamp and tag
      # ---------------------------------
      - name: Generate timestamp + tag
        id: stamp
        run: |
          TS=$(date -u +"%Y-%m-%d_%H-%M-%S")
          TAG="snapshot-$TS"  # fallback
          
          if [ "${{ github.event_name }}" != "schedule" ]; then
            TAG="build-$TS"
          fi
          
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Install build dependencies
      # ---------------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib flex git \
            libncurses-dev libssl-dev python3-distutils python3-setuptools \
            zlib1g-dev rsync swig unzip wget ccache

      # ---------------------------------
      # Clone OpenWrt
      # ---------------------------------
      - name: Clone OpenWrt source
        run: |
          git clone --depth 1 https://github.com/openwrt/openwrt.git src

      # ---------------------------------
      # Copy config
      # ---------------------------------
      - name: Apply custom .config
        run: |
          cp config/.config src/.config

      # ---------------------------------
      # Apply patches
      # ---------------------------------
      - name: Apply patches
        run: |
          cd src
          for p in ../patches/*.patch; do
            [ -f "$p" ] || continue
            echo "Applying $p"
            patch -p1 < "$p"
          done

      # ---------------------------------
      # Feeds
      # ---------------------------------
      - name: Update feeds
        run: |
          cd src
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ---------------------------------
      # defconfig
      # ---------------------------------
      - name: defconfig
        run: |
          cd src
          make defconfig

      # ---------------------------------
      # Detect target
      # ---------------------------------
      - name: Detect target
        id: detect_target
        run: |
          TARGET=$(grep "^CONFIG_TARGET_[^_]*=y" src/.config | sed 's/CONFIG_TARGET_//;s/=y//')
          SUBTARGET=$(grep "^CONFIG_TARGET_${TARGET}_.*=y" src/.config | sed "s/CONFIG_TARGET_${TARGET}_//;s/=y//")
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "subtarget=$SUBTARGET" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Detect profile
      # ---------------------------------
      - name: Detect profile
        id: detect_profile
        run: |
          PROFILE=$(grep "^CONFIG_TARGET_.*_DEVICE_.*=y" src/.config | sed 's/.*DEVICE_//;s/=y//')
          echo "profile=$PROFILE" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Detect WiFi packages
      # ---------------------------------
      - name: Detect WiFi drivers
        id: wifi
        run: |
          WIFI=$(grep -E "CONFIG_PACKAGE_(iw|iwinfo|hostapd|wpad|mt76|ath10k|ath9k)=y" src/.config || true)
          WIFI_LIST=$(echo "$WIFI" | sed 's/CONFIG_PACKAGE_//g;s/=y//g' | tr '\n' ' ')
          echo "wifi=$WIFI_LIST" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Generate changelog
      # ---------------------------------
      - name: Generate changelog
        id: changelog
        run: |
          git fetch --depth=20 origin main
          PREV=$(git rev-parse HEAD~1 || echo "INITIAL")
          CURRENT=$(git rev-parse HEAD)
          if [ "$PREV" = "INITIAL" ]; then
            echo "First build" > changelog.txt
          else
            git log --pretty=format:"%h - %s" $PREV..$CURRENT > changelog.txt
          fi
          echo "log<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Speed optimizations
      # ---------------------------------
      - name: Optimize build
        run: |
          echo "export CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "export CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
          echo "export MAKEFLAGS=-j$(nproc)" >> $GITHUB_ENV

      # ---------------------------------
      # Build OpenWrt
      # ---------------------------------
      - name: Build firmware
        run: |
          cd src
          make -j$(nproc) V=sc
        continue-on-error: true

      # ---------------------------------
      # Upload logs on failure
      # ---------------------------------
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: src/logs/

      # ---------------------------------
      # Upload firmware as artifact
      # ---------------------------------
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: src/bin/targets/${{ steps.detect_target.outputs.target }}/${{ steps.detect_target.outputs.subtarget }}/
          if-no-files-found: error

      # ----------------------------------------------------
      # Create GitHub Release
      # ----------------------------------------------------
      - name: Create Release
        if: ${{ steps.buildtype.outputs.snapshot == 'true' && github.event_name = 'schedule' }}
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "build-${{ github.run_number }}"
          release_name: "Build ${{ github.run_number }}"
          body: |
            ## Automatic OpenWrt Build
            - Profile: ${{ steps.detect_profile.outputs.profile }}
            - Target: ${{ steps.detect_target.outputs.target }}/${{ steps.detect_target.outputs.subtarget }}
            - WiFi: ${{ steps.wifi.outputs.wifi }}

            ### Changelog
            ${{ steps.changelog.outputs.log }}
          draft: false
          prerelease: false

      # ----------------------------------------------------
      # Upload compiled firmware to GitHub Release
      # ----------------------------------------------------
      - name: Upload release assets
        if: ${{ steps.buildtype.outputs.snapshot == 'true' && github.event_name == 'schedule' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: src/bin/targets/${{ steps.detect_target.outputs.target }}/${{ steps.detect_target.outputs.subtarget }}/
          asset_name: firmware-${{ steps.detect_profile.outputs.profile }}.zip
          asset_content_type: application/zip
