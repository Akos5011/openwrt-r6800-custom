name: Build OpenWrt (Stable Patch Workflow)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # nightly snapshot

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 720

    steps:
      # -----------------------------------------
      # Fetch repository
      # -----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------
      # Required build dependencies
      # -----------------------------------------
      - name: Install packages
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential gcc-multilib g++-multilib \
            flex bison gawk libncurses-dev libssl-dev \
            python3-distutils python3-setuptools \
            zlib1g-dev swig rsync unzip wget ccache patch

      # -----------------------------------------
      # Clone OpenWrt
      # -----------------------------------------
      - name: Clone OpenWrt master
        run: |
          git clone --depth 1 https://github.com/openwrt/openwrt.git src

      # -----------------------------------------
      # Apply custom .config from your repo
      # -----------------------------------------
      - name: Install .config
        run: |
          cp config/.config src/.config

      # -----------------------------------------
      # Apply patches from patches/
      # (We use ONLY patch -p1 to avoid git identity issues)
      # -----------------------------------------
      - name: Apply patches
        run: |
          cd src
          shopt -s nullglob
          for p in ../patches/*.patch; do
            echo "=== Applying $p ==="
            if patch -p1 < "$p"; then
              echo "Applied: $p"
            else
              echo "::error ::Patch failed: $p"
              exit 1
            fi
          done

      # -----------------------------------------
      # Install and update feeds
      # -----------------------------------------
      - name: Update feeds
        run: |
          cd src
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # -----------------------------------------
      # Expand config with defconfig
      # -----------------------------------------
      - name: Run defconfig
        run: |
          cd src
          make defconfig

      # -----------------------------------------
      # Build firmware
      # -----------------------------------------
      - name: Build firmware
        run: |
          cd src
          make -s -j$(nproc) V=sc

      # -----------------------------------------
      # Upload logs on failure
      # -----------------------------------------
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: src/logs/

      # -----------------------------------------
      # Upload firmware output
      # -----------------------------------------
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ steps.detect.outputs.profile }}
          path: src/bin/targets/${{ steps.detect.outputs.target }}/${{ steps.detect.outputs.subtarget }}/
          if-no-files-found: error

      # -----------------------------------------
      # Optional: Create GitHub Release (snapshot only)
      # -----------------------------------------
      - name: Create snapshot release
        if: github.event_name == 'schedule'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: snapshot-${{ steps.detect.outputs.profile }}-${{ github.run_id }}
          name: "Snapshot for ${{ steps.detect.outputs.profile }} (build ${{ github.run_id }})"
          body: |
            Snapshot firmware for:
            - Device: ${{ steps.detect.outputs.profile }}
            - Target: ${{ steps.detect.outputs.target }}/${{ steps.detect.outputs.subtarget }}
            - Build ID: ${{ github.run_id }}

          files: src/bin/targets/${{ steps.detect.outputs.target }}/${{ steps.detect.outputs.subtarget }}/**
